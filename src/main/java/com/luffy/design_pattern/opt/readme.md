# 重构代码
### 理论
* why
  重构的目的：为什么重构
> 对于项目来言，重构可以保持代码质量持续处于一个可控状态，不至于腐化到无可救药的地步。对于个人而言，重构非常锻炼一个人的代码能力，并且是一件非常有成就感的事情。它是我们学习经典设计思想、原则、模式、编程规范等理论知识的练兵场。

* what
  重构的对象：重构什么
> 按照重构规模可以分为大规模高层次的重构和小规模低层次的重构。前者包括对代码分层、模块化、解耦、梳理类之间的交互关系、抽象复用组件等。这部分工作利用的更多的是比较抽象比较顶层的设计思想、原则、模式。后者包括规范命名、注释、修正函数参数过多、消除大类、提取重复代码等编程细节问题，主要针对类、函数级别的重构。更多的是利用编码规范这一理论知识。

* when
  重构的时机：什么时候重构
> 持续重构意识，重构是代码开发必不可少的部分，要融入到日常开发中去，而不是等到代码无可救药的时候再去重构。

* how
  重构的方法：如何重构
> 持续重构决识，要有组织有计划重构，分阶段小步重构，要让代码时刻处于一个可运行的状态。做到每一阶段的重构不要耗时太长，不至于与新的功能开发冲突。对于低层次重构，要在平时开发代码时注意代码规范随时重构。


### 如何保障重构不出错（技术手段：可测试性代码）

**`单元测试`**：单元测试的测试对象是类或者函数，用来测试一个类和函数是否都按照预期的逻辑执行。这是底层代码的测试

**`集成测试`**：集成测试的测试对象是整个系统或者某个功能模块，比如测试用户注册、登录功能是否正常，是一种端到端的测试

intellj idea中基于gradle的java项目编写单元测试需要引入的包:
```gradle
testImplementation 'org.junit.jupiter:junit-jupiter-api:5.7.1'
testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine'
testImplementation 'junit:junit:4.13.1'
testRuntimeOnly 'org.junit.vintage:junit-vintage-engine'
```
>[具体官方解释](https://docs.gradle.org/current/userguide/java_testing.html#using_junit5)

* 如保编写可测试性代码
  依赖注入是编写可测试性代码的最有效手段。通过依赖注入，我们在编写单元测试的时候可以通过mock方式提供外部依赖服务，这也是我们在编写单元测试的时候最有挑战的地方
* 单元测试也是对代码的review和审视，也是代码重构的过程，能发现代码设计上的问题和代码中的bug
* 单元测试能帮助你快速熟悉代码
* 编写单元测试尽管繁琐，但并不是太耗时；
* 我们可以稍微放低对单元测试代码质量的要求；
* 覆盖率作为衡量单元测试质量的唯一标准是不合理的；
* 单元测试不要依赖被测代码的具体实现逻辑；
* 单元测试框架无法测试，多半是因为代码的可测试性不好。


## 如何解耦

1. 封装与抽象
   封闭与抽象可以有效地隐藏实现的复杂性，隔离实现的易变性，给依赖的模块提供稳定易用的抽象接口。

2. 中间层
   引入中间层能简化模块或类之间的依赖关系。
   为了让重构小步快跑，引入中间层可以分为四步：
> 1. 引入一个中间层，包裹老的接口，提供新的接口定义
> 2. 新开发的代码依赖中间层提供的新接口
> 3. 将依赖老接口的代码改为调用新接口
> 4. 确保所有的代码都调用新接口之后，删除掉老的接口

3. 模块化
   模块化是构建复杂系统常用的手段
   模块化的思想无处不在，像 SOA、微服务、lib库、系统内模块划分，甚至是类、函数的设计，都体现了模块化思想。如果追本溯源，模块化思想更加本质的东西就是分而治之。

4. 其他设计思想和原则
   单一职责原则、基于接口而非实现编程、依赖注入、多用组合少用继承、迪米特法则

## 编程规范
分为三个部分：命名与注释、代码风格、编程技巧

### 命名
1. 利用上下文简化命名
```java
User user = new User();
user.getName(); // 借助user对象这个上下文
```
```java
public void uploadUserAvatarImageToAliyun(String userAvatarImageUri);
//利用上下文简化为：
public void uploadUserAvatarImageToAliyun(String imageUri);
```
2. 命名要可读可搜索
   我们在命名时，最好要符合整个项目的命名习惯。大家都用“selectXXX”表示查询，你就不要用“queryXXX”；大家都用“insertXXX”表示插入一条数据，你就要不用“addXXX”，统一规约是很重要的，能减少很多不必要的麻烦。

3. 如何命名接口和抽象类
   接口有两种命名方式：一种是在接口中带前缀“I”；另一种是在接口的实现类中带后缀“Impl”。对于抽象类的命名，也有两种方式，一种是带上前缀“Abstract”，一种是不带前缀。这两种命名方式都可以，关键是要在项目中统一

### 注释
注释的目的是让代码更容易看懂。只要符合这个要求的注释，就写吧。
注释内容大概有三个方面：做什么、为什么、怎么做。
* 注释比代码承载的信息更多
* 注释起到总结性作用、文档性的作用
* 一些总结性注释能让代码结构更清晰

对于复杂的类和接口，我们可能还要写如何用。
注释本身有一定维护成本，所以并非越多越好。类和函数一定要写注释，而且要写得尽可能全面、详细，而函数内部的注释要相对少一些，一般都是靠好的命名、提炼函数、解释性变量、总结性注释来提高代码的可读性。

### 代码风格
1. 类、函数多大才合适

类：当一个类的代码读起来让你感觉头大了，实现某个功能时不知道该用哪个函数了，想用哪个函数翻半天都找不到了，只用到一个小功能要引入整个类（类中包含很多无关此功能实现的函数）的时候，这就说明类的行数过多了

函数：一个函数最好能完整地显示在 IDE 中，最大代码行数不能超过 50

2. 一行代码多长合适

一行代码最长最好不能超过 IDE 显示的宽度

3. 善用空格分隔单元块

对于比较长的函数，如果逻辑上可以分为几个独立的代码块，在不方便将这些独立的代码块抽取成小函数的情况下，可以使用空行来分割各个代码块

4. 四格缩进还是两格缩进

推荐两格缩进，在代码嵌套层次比较深的情况下，累计缩进较多的话，容易导致一个语句被折成两行，影响代码可读性。不要使用tab缩进

5. 大括号是否要另起一行

我个人还是比较推荐，将括号放到跟语句同一行的风格
```java
    public class ClassName {
        public void foo() {
            // method body
        }
    }
```

7. 类中成员的排列顺序

依赖类按照字母序从小到大排列

成员变量排在函数的前面。成员变量之间或函数之间，都是按照“先静态（静态函数或静态成员变量）、后普通（非静态函数或非静态成员变量）”的方式来排列的

除此之外，成员变量之间或函数之间，还会按照作用域范围从大到小的顺序来排列，先写 public 成员变量或函数，然后是 protected 的，最后是 private 的

### 编程技巧
* 将复杂的逻辑拆分成函数和类。
* 通过拆分成多个函数或将参数封装为对象的方式，来处理参数过多的情况。
* 函数中不要使用参数来做代码执行逻啊的控制。
* 函数设计要职责单一。
* 移除过深的嵌套层次，方法包括：去掉多余的if或else语句，使用continue、break、return关键字提前退出嵌套，调整执行顺序来减少嵌套，将部分嵌套逻辑抽象成函数。
* 用字面常量取代魔法数。
* 用解释性变量来解释复杂表达式，以此提高代码可读性。

## 如何发现代码质量问题
**常规checklist**
* 目录设置是否合理、模块划分是否清晰、代码结构是否满足“高内聚、松耦合”？
* 是否遵循经典的设计原则和设计思想（SOLID/DRY/KISS/YAGNI/LOD等）？
* 设计模式是否应用得当？是否有过度设计？
* 代码是否容易扩展？如果要添加新功能，是否容易实现？
* 代码是否可以复用？是否可以复用已有的项目代码或类库？是否有重复造轮子？
* 代码是否容易测试？单元测试是否全面覆盖各种正常和异常的情况？
* 代码是否易读？是否符合编码规范（比如命名和注释是否恰当、代码风格是否一致等）？

**业务需求checklist**
* 代码是否实现了预期的业务需求？
* 逻辑是否正确？是否处理了各种异常情况？
* 日志打印是否得当？是否方便debug排查问题？
* 接口是否易用？是否支持幂等、事务等？
* 代码是否存在并发问题？是否线程安全？
* 性能是否有优化空间，比如，SQL/算法是否可以优化？
* 是否有安全漏洞？比如，输入输出校验是否全面？

> 接品幂等性是指用户对于同一操作发起的一次请求或多次请求的结果是一致的，不会因为多次点击产生了副作用。 举个最简单的例子，那就是支付，用户购买商品后支付，支付扣款成功，但是返回结果的时候网络异常，此时钱已经扣了，用户再次点击按钮，此时会进行第二次扣款，返回结果成功，用户查询余额返发现多扣钱了，流水记录也变成了两条．．．这就没有保证接口的幂等性

## 重构代码步骤
1. 提高代码的可读性
2. 提高代码的可测试性
3. 编写完善的单元测试
4. 所有重构完成之后添加注释
>注释中主要写清楚：做什么、为什么、怎么做、怎么用，对一些边界条件、特殊情况进行说明，以及对输入、输出、异常进行说明


## 处理函数出错
函数出错应该返回什么

* 错误码

> 错误码的返回方式有两种：
>> 1. 占用函数的返回值，函数正常执行的返回值放到出参中
>> 2. 将错误码定义为全局变量，在函数执行出错时，函数调用者通过这个全局变量来获取错误码

* NULL值

> 返回空对象可能使调用方在使用返回值时造成空指针
> 但对于get/find/select/search/query等单词开头的查找函数来说，数据不存在是正常情况，所以返回null比返回异常更合理。其实这种情况要看项目中其他查找函数是如何返回的，统 一约定即可。

* 空对象

> 为了避免空指针异常，我们通常可以返回空对象或空集合

* 异常对象
  最常用的函数出错处理方式是抛出异常。异常抛出有两种类型：受检异常和非受检异常。
  到底是选择受检和非受检异常根据团队开发习惯在项目中统一处理就行。
  函数抛出异常的三种处理：
* 直接吞掉
* 直接往上抛
* 包裹成新的异常抛出